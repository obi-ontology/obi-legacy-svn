<?xml version="1.0" encoding="UTF-8"?>
<project name="build" default="help" basedir="."
  xmlns:ivy="antlib:org.apache.ivy.ant">
  <tstamp>
    <format property="date" pattern="yyyy-MM-dd"/>
  </tstamp>

  <loadproperties srcFile="config.properties" />
  <property name="src" value="src/main/java" />
  <property name="resources" value="src/main/resources" />
  <property name="dist" value="dist" />
  <property name="test" value="src/test/java" />
  <property name="target" value="target" />
  <property name="release" value="release" />
  <property name="classes" value="${target}/classes" />
  <property name="javadoc" value="${target}/javadoc" />
  <property name="test-classes" value="${target}/test-classes" />
  <property name="test-results" value="${target}/test-results" />
  <property name="test-reports" value="${target}/test-reports" />
  <property name="lib" value="lib" />
  <property name="doap_file" value="${dist}/doap.xml" />

  <!-- HELP -->
  <target name="help" description="Print project help">
    <java classname="org.apache.tools.ant.Main">
      <arg value="-projecthelp" />
      <arg value="-buildfile" />
      <arg value="${ant.file}" />
    </java>
  </target>

  <!-- INIT -->
  <target name="init" depends="" description="Prepare for build">
    <path id="classpath">
      <fileset dir="${lib}">
        <include name="*.jar" />
      </fileset>
    </path>
    <pathconvert property="mf.classpath" pathsep=" ">
      <path refid="classpath"/>
      <mapper>
        <chainedmapper>
          <flattenmapper/>
          <globmapper from="*.jar" to="lib/*.jar"/>
        </chainedmapper>
      </mapper>
    </pathconvert>
  </target>

  <!-- CLEAN -->
  <target name="clean" depends="" description="Clean all non-source files">
    <echo message="Cleaning non-source directories in ${basedir}" />
    <delete dir="${dist}" />
    <delete dir="${release}" />
    <delete dir="${target}" />
  </target>

  <!-- DEPS -->
  <!-- Requires Apache Ivy to be installed for Ant. -->
  <target name="deps" description="Retrieve dependencies with Apache Ivy">
    <ivy:retrieve />
  </target>

  <!-- COMPILE -->
  <target name="compile" depends="init" description="Compile the project">
    <mkdir dir="${target}" />
    <mkdir dir="${classes}" />
    <javac destdir="${classes}" classpathref="classpath" optimize="false" debug="true" includeantruntime="false">
      <src path="${src}" />
    </javac>
  </target>

  <!-- DOAP -->
  <target name="doap" depends="" description="Updated Description of a Project File">
    <copy file="${ontology_path}/${doap_path}" tofile="${doap_file}" overwrite="yes"/>
    <replace file="${doap_file}" token="__VERSION_GOES_HERE__" value="${date}"/>
    <replace file="${doap_file}" token="__PRETTY_NAME_GOES_HERE__" value="${release_name}"/>
  </target>

  <!-- ASSIGN -->
  <target name="assign-ids" depends="compile" description="Assign OBI IDs">
    <java classname="obi.Assigner">
      <classpath>
          <path refid="classpath"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="${ontology_path}/${obi_path}"/>
    </java>
  </target>

  <!-- BUILD -->
  <target name="build" depends="compile, doap" description="Merge OBI into a single OWL file">
    <java classname="obi.Builder">
      <classpath>
          <path refid="classpath"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="${ontology_path}/${obi_path}"/>
      <arg value="${dist}/obi_merged.owl"/>
      <arg value="${dist}/obi.owl"/>
      <arg value="${dist}/warnings.tsv"/>
    </java>
    <java classname="obi.Metadator">
      <classpath>
          <path refid="classpath"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="${ontology_path}/${obi_path}"/>
      <arg value="${doap_file}"/>
      <arg value="${date}"/>
      <arg value="http://purl.obolibrary.org/obo/obi/${date}/obi.owl"/>
      <arg value="${dist}/obi.owl"/>
    </java>
  </target>

  <!-- UPDATE -->
  <target name="update-terms" depends="build" description="Check and update all terms">
    <java classname="obi.TermUpdater">
      <classpath>
          <path refid="classpath"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="${dist}/obi_merged.owl"/>
      <arg value="${dist}/warnings.tsv"/>
      <arg value="${dist}/obi.owl"/>
    </java>
  </target>

  <!-- REASON -->
  <target name="reason" depends="build" description="Reason over the built OBI and save the results">
    <java classname="obi.Reasoner">
      <classpath>
          <path refid="classpath"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="${dist}/obi.owl"/>
      <arg value="${dist}/obi.owl"/>
    </java>
  </target>

  <!-- REPORT -->
  <target name="report" depends="compile" description="Report on OBI">
    <java classname="obi.Reporter">
      <classpath>
          <path refid="classpath"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="${dist}/obi.owl"/>
      <arg value="${dist}/obi.tsv"/>
      <arg value="${dist}/obi.txt"/>
    </java>
  </target>

  <!-- CORE -->
  <target name="core" depends="build" description="Extract the Core">
    <java classname="obi.Extractor">
      <classpath>
          <path refid="classpath"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="${dist}/obi.owl"/> <!-- TODO: Check this!! -->
      <arg value="${core_iris}"/>
      <arg value="${dist}/obi_core.owl"/>
      <arg value="${base_iri}/obi_core.owl"/>
    </java>
    <java classname="obi.Metadator">
      <classpath>
          <path refid="classpath"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="${ontology_path}/${obi_path}"/>
      <arg value="${doap_file}"/>
      <arg value="${date}"/>
      <arg value="http://purl.obolibrary.org/obo/obi/${date}/obi_core.owl"/>
      <arg value="${dist}/obi_core.owl"/>
    </java>
    <java classname="obi.Reporter">
      <classpath>
          <path refid="classpath"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="${dist}/obi_core.owl"/>
      <arg value="${dist}/obi_core.tsv"/>
      <arg value="${dist}/obi_core.txt"/>
    </java>
  </target>

  <!-- IEDB -->
  <target name="iedb" depends="build" description="Build the IEDB view of OBI">
    <java classname="obi.ViewMaker">
      <classpath>
          <path refid="classpath"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="${dist}/obi.owl"/>
      <arg value="${dist}/obi_iedb.owl"/>
      <arg value="http://purl.obolibrary.org/obo/OBI_9991118"/>
    </java>
    <java classname="obi.Metadator">
      <classpath>
          <path refid="classpath"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="${ontology_path}/${obi_path}"/>
      <arg value="${doap_file}"/>
      <arg value="${date}"/>
      <arg value="http://purl.obolibrary.org/obo/obi/${date}/obi_iedb.owl"/>
      <arg value="${dist}/obi_iedb.owl"/>
    </java>
    <java classname="obi.Reporter">
      <classpath>
          <path refid="classpath"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="${dist}/obi_iedb.owl"/>
      <arg value="${dist}/obi_iedb.tsv"/>
      <arg value="${dist}/obi_iedb.txt"/>
    </java>
  </target>


  <!-- RELEASE -->
  <target name="release" depends="build, reason, report, core, iedb"
    description="Build all OBI files for release">
    <delete dir="${release}"/>
    <mkdir  dir="${release}"/>
    <copy todir="${release}">
      <fileset dir="${dist}">
        <include name="obi.owl"/>
        <include name="obi_core.owl"/>
        <include name="obi_iedb.owl"/>
      </fileset>
    </copy>

    <mkdir  dir="${release}/docs"/>
    <copy todir="${release}/docs">
      <fileset dir="${dist}">
        <include name="obi.tsv"/>
        <include name="warnings.tsv"/>
        <include name="obi_core.tsv"/>
        <include name="obi_iedb.tsv"/>
      </fileset>
    </copy>

    <mkdir  dir="${release}/branches"/>
    <copy todir="${release}/branches/">
      <fileset dir="${ontology_path}/branches">
        <include name="catalog-v001.xml"/>
        <include name="doap.template"/>
        <include name="external-byhand.owl"/>
        <include name="obi.owl"/>
        <include name="OntoFox_inputs/*.txt"/>
        <include name="OntoFox_outputs/*.owl"/>
      </fileset>
    </copy>

    <mkdir  dir="${release}/external/bfo2-alan"/>
    <copy todir="${release}/external/bfo2-alan">
      <fileset dir="${ontology_path}/external/bfo2-alan" includes="**"/>
    </copy>

    <mkdir  dir="${release}/external/iao-bfo2"/>
    <copy todir="${release}/external/iao-bfo2">
      <fileset dir="${ontology_path}/external/iao-bfo2" includes="**"/>
    </copy>

    <copy todir="${release}/external/">
      <fileset dir="${ontology_path}/external/">
        <include name="protege-dc.owl"/>
      </fileset>
    </copy>

    <echo message="Release directory created in '${release}'"/>
    <echo message="You may want to copy lists of new terms to '${release}/docs'"/>
  </target>

  <!-- TEST -->
  <target name="test" depends="compile" description="Run all OBI tests">
    <mkdir dir="${target}/tests" />
    <java classname="obi.Tester">
      <classpath>
          <path refid="classpath"/>
          <path location="${resources}"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="../../tests"/>
      <arg value="${target}/tests"/>
    </java>
  </target>

  <!-- EXPERIMENT -->
  <target name="experiment" depends="compile" description="Test files in the 'experiments' dir">
    <mkdir dir="${target}/tests" />
    <java classname="obi.Tester">
      <classpath>
          <path refid="classpath"/>
          <path location="${resources}"/>
          <path location="${classes}"/>
      </classpath>
      <arg value="experiments"/>
      <arg value="${target}/experiments"/>
    </java>
  </target>

  <!-- ALL -->
  <target name="all" depends="clean, init, compile, build" description="Run the complete workflow">
    <echo message="OBI built!" />
  </target>


</project>
